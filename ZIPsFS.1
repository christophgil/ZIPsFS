'\" t
.\" Automatically generated by Pandoc 2.17.1.1
.\"
.\" Define V font for inline verbatim, using C font in formats
.\" that render this, and otherwise B font.
.ie "\f[CB]x\f[]"x" \{\
. ftr V B
. ftr VI BI
. ftr VB B
. ftr VBI BI
.\}
.el \{\
. ftr V CR
. ftr VI CI
. ftr VB CB
. ftr VBI CBI
.\}
.TH "ZIPsFS" "1" "" "" ""
.hy
.SH NAME
.PP
\f[B]ZIPsFS\f[R] - FUSE-based overlay union file system expanding ZIP
files
.SH Example usage
.IP
.nf
\f[C]
ZIPsFS [ZIPsFS-options] path-of-branch1/  branch2/  branch3/  branch4/  :  [fuse-options] mount-point
\f[R]
.fi
.SH Summary
.PP
ZIPsFS functions as a \f[B]union or overlay\f[R] file system, merging
multiple file structures into a unified directory.
This directory presents the underlying files and sub-directories from
the specified sources (branches) as a single, cohesive structure.
Any newly created or modified files are stored in the first file
location, while all other sources remain read-only, ensuring that their
files are never altered.
ZIPsFS treats \f[B]ZIP files as expandable folders\f[R], typically
naming them by appending \f[V].Contents/\f[R] to the original ZIP file
name.
However, this behavior can be customized using filename-based rules.
Extensive configuration options allow adjustments.
Changes can be applied without disrupting the file system.
.PP
With a trailing slash, the folder name is not part of the virtual path,
in accordance with the trailing slash semantics of many UNIX tools.
.PP
ZIPsFS includes specialized features like \f[B]automatic file
conversions\f[R] and performance optimizations tailored for efficiently
storing and accessing \f[B]large-scale mass spectrometry\f[R] data.
It manages non-sequential file reading from varying positions (so-called
file seek) efficiently to improve reading of remote and zipped files.
It has a programming interface to create synthetic file content
programmatically.
.PP
ZIPsFS is best run in a \f[B]tmux\f[R] session.
.SH Mini tutorial
.PP
Please Install ZIPsFS.
.SS Create some example files
.PP
Without trailing slash, the folder name will be retained in the virtual
path.
This is the case for \f[V]branch3\f[R].
Virtual file paths in that branch will start with \f[I]mount
point\f[R]\f[V]/branch3/\f[R].
.IP
.nf
\f[C]
b1=\[ti]/test/ZIPsFS/writable/
b2=\[ti]/test/ZIPsFS/branch1/
b3=\[ti]/test/ZIPsFS/branch2/
b4=\[ti]/test/ZIPsFS/branch3

mkdir -p $b1 $b2 $b3 $b4 \[ti]/test/ZIPsFS/mnt

for c in a b c d e f; do echo hello world $c >$b2/$c.txt; done
for ((i=0;i<10;i++)); do echo hello world $i >$b3/$i.txt; done

zip --fifo $b2/zipfile1.zip <(date)  <(echo $RANDOM)
zip --fifo $b3/zipfile2.zip <(hostname)  <(ls /)
zip --fifo $b3/20250131_this_is_a_mass_spectrometry_folder.d.Zip   <(seq 10)
\f[R]
.fi
.SS Start ZIPsFS
.PP
In production, it is recommended to start ZIPsFS in \f[I]tmux\f[R].
For testing, just use your regular command line.
.IP
.nf
\f[C]
ZIPsFS   $b1 $b2 $b3 $b4  :  \[ti]/test/ZIPsFS/mnt
\f[R]
.fi
.SS Browse the virtual file tree
.PP
Open a file browser or another terminal and browse the files in
.IP
.nf
\f[C]
\[ti]/test/ZIPsFS/mnt/
\f[R]
.fi
.SS Create a file in the virtual tree
.PP
The first file tree stores files.
All others are read-only.
.IP
.nf
\f[C]
echo \[dq]Hello\[dq] > \[ti]/test/ZIPsFS/mnt/my_file.txt

cat \[ti]/test/ZIPsFS/mnt/my_file.txt
\f[R]
.fi
.PP
To get the real storage place of the file, append
\f[V]\[at]SOURCE.TXT\f[R]
.IP
.nf
\f[C]
cat \[ti]/test/ZIPsFS/mnt/my_file.txt\[at]SOURCE.TXT
\f[R]
.fi
.SS Access web resources as regular files (Not fully tested yet)
.PP
Make sure the UNIX tool curl is installed.
.IP
.nf
\f[C]
curl --version
\f[R]
.fi
.PP
Note that \[lq]//:\[rq] and all slashes in the URL are replaced by
commas.
.IP
.nf
\f[C]
less  \[ti]/test/ZIPsFS/mnt/ZIPsFS/n/ftp,,,ftp.uniprot.org,pub,databases,uniprot,LICENSE

gunzip -c \[ti]/test/ZIPsFS/mnt/ZIPsFS/n/ftp,,,ftp.ebi.ac.uk,pub,databases,uniprot,current_release,knowledgebase,complete,docs,keywlist.xml.gz
\f[R]
.fi
.PP
Even though the file is only available in compressed form on the server,
you can directly access the decompressed file.
Omit the \f[V].gz\f[R] extension.
.PP
The decompressed file size is an estimate.
It becomes exactly known after reading the file.
.IP
.nf
\f[C]
head \[ti]/test/ZIPsFS/mnt/ZIPsFS/n/http,,,ftp.uniprot.org,pub,databases,uniprot,current_release,knowledgebase,reference_proteomes,Eukaryota,UP000005640,UP000005640_9606.fasta
head \[ti]/test/ZIPsFS/mnt/ZIPsFS/n/ftp,,,ftp.uniprot.org,pub,databases,uniprot,current_release,knowledgebase,reference_proteomes,Eukaryota,UP000005640,UP000005640_9606.fasta


ls -l \[ti]/test/ZIPsFS/mnt/ZIPsFS/n/ftp,,,ftp.ebi.ac.uk,pub,databases,uniprot,current_release,knowledgebase,complete,docs,keywlist.xml

head \[ti]/test/ZIPsFS/mnt/ZIPsFS/n/ftp,,,ftp.ebi.ac.uk,pub,databases,uniprot,current_release,knowledgebase,complete,docs,keywlist.xml
\f[R]
.fi
.PP
From now on, the file size is known.
.PP
The gz compression is built-in using the zlib C library.
The bz2, xz and lrz decompression work only if activated in the config
(default) and if the respective backends are installed on the computer.
The following are test examples of files remotely stored as bz2 and xz,
respectively.
.IP
.nf
\f[C]
head \[ti]/test/ZIPsFS/mnt/ZIPsFS/n/http,,,ftp.gnu.org,gnu,binutils,binutils-2.23.1.tar   # Remote file is .tar.bz2
head \[ti]/test/ZIPsFS/mnt/ZIPsFS/n/http,,,ftp.gnu.org,gnu,gawk,gawk-4.0.2.tar            # Remote file is .tar.xz
\f[R]
.fi
.PP
Above method allows to access any remote file.
The disadvantage over the method below is, that repositories are not
browsable.
.SS Special directory prefixes
.IP \[bu] 2
/ZIPsFS/p Rapid navigation and file name searching without time
consuming ZIP file expansion.
.IP \[bu] 2
/ZIPsFS/n Internet files.
Take URL and replace colon and slashes by comma.
See above tutorial.
.IP \[bu] 2
/ZIPsFS/lrz Remote and zipped files are prefetched before reading.
For FragPipe, use raw files from here.
.IP \[bu] 2
/ZIPsFS/c Converted files like mgf and mzML from raw mass spectrometry
files or tsv from parquet files.
Note that the mzML files are not suitable for FragPipe.
FragPipe is generating its own mzML variant.
.IP \[bu] 2
/ZIPsFS/1 All files ever written or generated or modified.
.PP
Details are found in the contained readme files.
.SS Properties of upstream file trees
.PP
In the command line, root file paths can be followed by expressions like
\[at]immutable=1 to set specific properties.
Alternatively, properties can be written in a file
\f[V]<property-path>.ZIPsFS.properties\f[R].
Take a look at ZIPsFS_prepare_branch_for_ftp.sh.
.PP
List (Incomplete) of root path properties:
.IP \[bu] 2
\f[V]path-prefix=dir/subdir/subsubdir\f[R] Files in this root are
accessible with paths starting with /dir/subdir/subsubdir/\&...
.IP \[bu] 2
\f[V]one-file-system=1\f[R] Mount points or symbolic links expanded in
ZIPsFS can point outside this file system.
This is prevented with this property.
Consider this property when the ZIPsFS file system is accessible from
other computers.
.IP \[bu] 2
\f[V]follow-symlinks=1\f[R] Symlinks are expanded within ZIPsFS.
Dangerous!
Consider combining with \f[V]\[at]one-file-system=1\f[R].
.IP \[bu] 2
\f[V]immutable=1\f[R] In the respective file tree, no files are changed,
deleted or created.
This optimizes caching.
Cached file attributs and listings will not expire.
.IP \[bu] 2
\f[V]worm=1\f[R] File tree is write-once-read-many.
Same consequence as above.
.IP \[bu] 2
\f[V]preload=1\f[R] Before reading file content, files are downloaded to
the first file tree.
.IP \[bu] 2
\f[V]preload-gz=1\f[R] If a non-existing file is requested while a
gz-compressed file exists, the decompressed file will be generated.
Also available bz2, lrz, Z and xz.
Security: Symbolic links and mount points
.PP
When the FUSE file system is exported via NFS or Samba, navigation into
forbiddeden folders such as \f[V]/etc/passwd\f[R] needs to be prevented.
Symbolic links and mount points could direct into other file systems.
.PP
Even though symbolic links can be created in the virtual file system and
work as expected, on the local machine, they are normally not expanded
inside ZIPsFS and the target may not be visible through NFS or SMB.
.PP
In rare cases symbolic links need to be expanded in ZIPsFS.
In this case the respective root-path need the property
\f[V]follow-symlinks=1\f[R].
Either this is added as a line to a textfile with a path formed by
appending \f[V].ZIPsFS.properties\f[R] to the root-path or with a
command line parameter \f[V]\[at]follow-symlinks=1\f[R] after the
root-path.
.PP
Expansion of symlinks is performed only if the target is within the
given file trees or if the configurable function
\f[V]config_allow_expand_symlink(orig_path,expanded_path)\f[R] returns
true.
.PP
Users may expose sensitive files by creating an empty folder as mount
point and running \f[V]bindfs /etc   created-empty-folder\f[R].
Redirection can be prevented by adding the property
\f[V]one-file-system=1\f[R].
Browsing public repositories (Pride, Genomes, PDB, Swissprot)
.PP
Warning: this new feature is not yet fully tested!
.PP
Please install https://curlftpfs.sourceforge.net/ and curl.
Consider to add timeout like
\f[V]curl_easy_setopt(easy,CURLOPT_TIMEOUT,3600);\f[R] into the
\f[V]main()\f[R] function in \f[V]ftpfs.c\f[R].
.SS Browsing FTP sites using nested Curlftpfs
.PP
The script file ZIPsFS_prepare_branch_for_ftp.sh generates an example
folder \f[V]\[ti]/.ZIPsFS/DBcurlftpfs\f[R] with Curlftpfs mounts to be
used in ZIPsFS.
.PP
Above command line to start ZIPsFS can extended to include this folder:
.IP
.nf
\f[C]
ZIPsFS   $b1 $b2 $b3 $b4  --preload \[ti]/.ZIPsFS/DB  :  \[ti]/test/ZIPsFS/mnt
\f[R]
.fi
.PP
Due to the option \f[V]--preload\f[R], files are mirrord to the first
branch on the local file system for fast access.
Lets try
.IP
.nf
\f[C]
ls \[ti]/test/ZIPsFS/mnt/DBcurlftpfs
\f[R]
.fi
.PP
GZ compressed files are transparently de-compressed.
Files with the ending \f[V].gz\f[R] also appear in the file listing
without gz suffix.
Initially, they have an estimated file size.
After reading the virtual file, the exact length of the decompressed
data is known.
.PP
Performance: Without a trailing slash in the command line, the folder
name \f[V]/DB/\f[R] will be the beginning of virtual paths.
This is important for performance, because it avoids that the curlftpfs
file systems will be requested for each file lookup.
Only if virtual paths start with \f[V]/DB/\f[R], curlftpfs gets
involved.
.SS Browsing FTP sites using nested Avfs
.PP
Avfs can also be used.
Please see ZIPsFS_prepare_branch_for_ftp_avfs.sh
.SH DESCRIPTION
.SS ZIPsFS is a Union / overlay file system
.PP
ZIPsFS functions as a union (overlay) file system.
When files are created or modified, they are stored in the first file
tree.
If a file exists in multiple source locations, the version from the
leftmost source (the first one listed) takes precedence.
With an empty string as the first source, the ZIPsFS file system
read-only and file creation and modification is disabled.
.PP
The physical file path, i.e., the actual storage location of a file, can
be retrieved from a file formed by appending \f[V]\[at]SOURCE.TXT\f[R]
to the filename.
For example, to determine the real location of:
\f[V]\[ti]/test/ZIPsFS/mnt/1.txt\f[R] Run the following command:
.IP
.nf
\f[C]
cat \[ti]/test/ZIPsFS/mnt/1.txt\[at]SOURCE.TXT
\f[R]
.fi
.PP
If a remote upstream file system stops responding, the current file
access is blocked (Unless the options \f[V]WITH_ASYNC_READDIR\f[R] \&...
are activated).
After some time, unresponsive upstream file trees will be skipped to
prevent that file accesses get blocked.
.SS ZIPsFS expands ZIP file entries
.PP
By default, ZIP files are displayed as folders with the suffix
\f[V].Content\f[R].
This behavior can be customized.
The default configuration includes a few exceptions tailored to specific
use cases in Mass Spectrometry:
.IP \[bu] 2
For ZIP files whose names end with \f[I].d.Zip\f[R], the virtual folder
will end with \f[I].d\f[R].
.IP \[bu] 2
Flat file list: For Sciex instruments, each mass spectrometry record is
stored in a set of files which are not organized in sub-folders.
For example the record
\f[V]20231122_MA_HEK_QC_hiFlow_2ug_SWATH_rep01\f[R] stored in
\f[V]20231122_MA_HEK_QC_hiFlow_2ug_SWATH_rep01.wiff2.Zip\f[R] may
consist of the following files
.RS 2
.IP \[bu] 2
20231122_MA_HEK_QC_hiFlow_2ug_SWATH_rep01.timeseries.data
.IP \[bu] 2
20231122_MA_HEK_QC_hiFlow_2ug_SWATH_rep01.wiff
.IP \[bu] 2
20231122_MA_HEK_QC_hiFlow_2ug_SWATH_rep01.wiff2
.IP \[bu] 2
20231122_MA_HEK_QC_hiFlow_2ug_SWATH_rep01.wiff.scan
.PP
These are contained with those of other entries in the file listing.
To get the full list of files, all ZIP files need to be inspected.
This is time consuming and performed in the background.
Consequently, the file listing will be incomplete when requested for the
first time.
Only after some seconds, the file listing will be presented properly.
.RE
.SS File content pre-load
.PP
Non-linear file loading in a random-access manner is inefficient for
remote or ZIP-compressed files.
This is the case for the MS-programs Diann and FragPipe (Fragger).
Preload files
.PP
Remote or compressed files can be preloaded in two different ways: (I)
into RAM or (II) to the local disk.
.SS Preloading into RAM
.PP
File names to be cached in RAM are specified in the configurable method
\f[V]config_advise_cache_in_ram()\f[R].
The default setting includes Brukertimstof mass-spectrometry files.
Preloading to the RAM is appropriate for these files because each file
is loaded only once per analysis.
It is necessary because these mass-spectrometry files are loaded from
varying file positions which would be inefficient for remote or
compressed files.
The \f[V]-l\f[R] option sets an upper limit on memory usage for the ZIP
RAM cache.
When available memory runs low, ZIPsFS can either pause, proceed without
caching file data or just ignore the memory restriction depending on the
configuration.
.SS Preloading to local disk
.PP
File reading of remote or compressed files can be improved by caching
the file content on the local disk.
This is for example necessary for Thermo mass-spectrometry raw files
analyzed in FragPipe.
Above method of preloading into RAM is here inappropriate because each
raw file is opened and closed multiple times during computation such
that the large files would be transfered from the NAS several times.
.PP
All remote (r) or compressed (c) or zippded (z) files accessed through
the following folders will be first copied to local disk:
.IP
.nf
\f[C]
<mount-point>/ZIPsFS/lr/
<mount-point>/ZIPsFS/lrc/
<mount-point>/ZIPsFS/lrz/
\f[R]
.fi
.PP
The Readme in these folders provide further information.
Alternatively, the entire root-path can be marked for preloading with
the property \f[V]\[at]preload\f[R].
Decompression is enabled with properties like \f[V]\[at]preload-gz\f[R]
.SS ZIPsFS Options
.PP
\f[B]-h\f[R]
.PP
Prints brief usage information.
.PP
**-s *path-of-symbolic-link** This is discussed in section
Configuration.
.PP
\f[B]-c [NEVER,SEEK,RULE,COMPRESSED,ALWAYS]\f[R]
.PP
Policy when ZIP entries and file content is cached in RAM.
.PP
.TS
tab(@);
cw(7.9n) lw(62.1n).
T{
NEVER
T}@T{
ZIP entries are never cached, even not in case of backward seek.
T}
T{
T}@T{
T}
T{
SEEK
T}@T{
ZIP entries are cached when the file position jumps backward.
T}
T{
T}@T{
T}
T{
RULE
T}@T{
ZIP entries are cached according to customizable rules or on backward
seed.
(DEFAULT)
T}
T{
T}@T{
T}
T{
COMPRESSED
T}@T{
All compressed ZIP entries are cached.
T}
T{
T}@T{
T}
T{
ALWAYS
T}@T{
All ZIP entries are cached.
T}
T{
T}@T{
T}
.TE
.PP
\f[B]-l \f[BI]Maximum memory for caching ZIP-entries in the
RAM\f[B]\f[R]
.PP
Specifies a limit for the cache.
For example \f[I]-l 8G\f[R] would limit the size of the cache to 8
Gigabyte.
File content larger than this will not be cached.
When memory usage is high, cached file access waits until it drops below
this value.
.PP
\f[B]-b\f[R] Execution in background (Not recommended).
We recommend running ZIPsFS in foreground in \f[I]tmux\f[R].
.SS FUSE Options
.PP
Options for the FUSE system come after the \f[B]colon\f[R] in the
command line.
.PP
\f[B]-o \f[BI]comma separated Options\f[B]\f[R]
.PP
\f[B]-o allow_other\f[R] Other users are granted access.
Project status
.PP
Author: Christoph Gille
.PP
\f[B]Current status\f[R]: Testing and Bug fixing.
Already running very busy for several weeks without interruption.
.PP
If ZIPsFS crashes, please send the stack-trace together with the source
code you were using.
